top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@
CPPFLAGS = -I${top_srcdir}/include -I../..
CFLAGS   = -g -Wall
LDFLAGS  =
CC = @CC@

# Legacy test programs (print-based, no assertions)
TESTPROGS = \
	ircd_chattr_t \
	ircd_in_addr_t \
	ircd_match_t \
	ircd_string_t

# CMocka test programs (proper assertions)
CMOCKA_TESTPROGS = \
	ircd_chattr_cmocka \
	ircd_match_cmocka \
	ircd_string_cmocka \
	numnicks_cmocka \
	ircd_in_addr_cmocka \
	ircd_compress_cmocka

CMOCKA_LIBS = -lcmocka
ZSTD_LIBS = -lzstd

DEP_SRC = \
	ircd_chattr_t.c \
	ircd_in_addr_t.c \
	ircd_match_t.c \
	ircd_string_t.c \
	ircd_chattr_cmocka.c \
	ircd_match_cmocka.c \
	ircd_string_cmocka.c \
	numnicks_cmocka.c \
	ircd_in_addr_cmocka.c \
	ircd_compress_cmocka.c \
	test_stub.c

all: ${TESTPROGS}

build: ${TESTPROGS}

# Build CMocka tests separately (requires libcmocka-dev)
cmocka: ${CMOCKA_TESTPROGS}

depend: ${DEP_SRC}
	@cd ${srcdir} && \
	if [ -f Makefile.in.bak ]; then \
	  echo "make depend: First remove ircd/Makefile.in.bak"; \
	else \
	  mv Makefile.in Makefile.in.bak && \
	  grep -A1 -B10000 '^# DO NOT DELETE THIS LINE' Makefile.in.bak > Makefile.in && \
	  ${CC} ${CFLAGS} -MM ${CPPFLAGS} ${DEP_SRC} >> Makefile.in; \
	fi

install:

IRCD_CHATTR_T_OBJS = ircd_chattr_t.o test_stub.o ../ircd_string.o
ircd_chattr_t: $(IRCD_CHATTR_T_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_CHATTR_T_OBJS)

IRCD_IN_ADDR_T_OBJS = ircd_in_addr_t.o test_stub.o ../ircd_alloc.o ../ircd_string.o ../match.o ../numnicks.o
ircd_in_addr_t: $(IRCD_IN_ADDR_T_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_IN_ADDR_T_OBJS)

IRCD_MATCH_T_OBJS = ircd_match_t.o test_stub.o ../ircd_string.o ../match.o
ircd_match_t: $(IRCD_MATCH_T_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_MATCH_T_OBJS)

IRCD_STRING_T_OBJS = ircd_string_t.o test_stub.o ../ircd_string.o
ircd_string_t: $(IRCD_STRING_T_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_STRING_T_OBJS)

# CMocka tests - these use proper assertions
# All CMocka tests need test_stub.o for log_write/log_inassert stubs
IRCD_CHATTR_CMOCKA_OBJS = ircd_chattr_cmocka.o test_stub.o ../ircd_string.o
ircd_chattr_cmocka: $(IRCD_CHATTR_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_CHATTR_CMOCKA_OBJS) $(CMOCKA_LIBS)

IRCD_MATCH_CMOCKA_OBJS = ircd_match_cmocka.o test_stub.o ../ircd_string.o ../match.o
ircd_match_cmocka: $(IRCD_MATCH_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_MATCH_CMOCKA_OBJS) $(CMOCKA_LIBS)

IRCD_STRING_CMOCKA_OBJS = ircd_string_cmocka.o test_stub.o ../ircd_string.o
ircd_string_cmocka: $(IRCD_STRING_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_STRING_CMOCKA_OBJS) $(CMOCKA_LIBS)

NUMNICKS_CMOCKA_OBJS = numnicks_cmocka.o test_stub.o ../numnicks.o ../ircd_string.o ../ircd_alloc.o ../match.o
numnicks_cmocka: $(NUMNICKS_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(NUMNICKS_CMOCKA_OBJS) $(CMOCKA_LIBS)

IRCD_IN_ADDR_CMOCKA_OBJS = ircd_in_addr_cmocka.o test_stub.o ../ircd_string.o ../match.o ../numnicks.o ../ircd_alloc.o
ircd_in_addr_cmocka: $(IRCD_IN_ADDR_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_IN_ADDR_CMOCKA_OBJS) $(CMOCKA_LIBS)

# ircd_compress tests - requires zstd library
IRCD_COMPRESS_CMOCKA_OBJS = ircd_compress_cmocka.o test_stub.o ../ircd_compress.o
ircd_compress_cmocka: $(IRCD_COMPRESS_CMOCKA_OBJS)
	${CC} -o $@ $(LDFLAGS) $(IRCD_COMPRESS_CMOCKA_OBJS) $(CMOCKA_LIBS) $(ZSTD_LIBS)

.c.o:
	${CC} ${CFLAGS} ${CPPFLAGS} -c $< -o $@

.PHONY: distclean clean test test-cmocka test-all cmocka

# Run legacy unit tests (default - runs during Docker build)
test: ${TESTPROGS}
	@echo "Running nefarious unit tests..."
	@failed=0; \
	for t in ${TESTPROGS}; do \
		echo "  Running $$t..."; \
		if ./$$t > $$t.log 2>&1; then \
			echo "    PASSED"; \
		else \
			echo "    FAILED (exit code $$?)"; \
			cat $$t.log; \
			failed=1; \
		fi; \
	done; \
	if [ $$failed -eq 0 ]; then \
		echo "All unit tests passed."; \
	else \
		echo "Some tests failed!"; \
		exit 1; \
	fi

# Run CMocka tests (requires libcmocka-dev)
test-cmocka: ${CMOCKA_TESTPROGS}
	@echo "Running CMocka unit tests..."
	@failed=0; \
	for t in ${CMOCKA_TESTPROGS}; do \
		echo "  Running $$t..."; \
		if ./$$t 2>&1 | tee $$t.log; then \
			: ; \
		else \
			failed=1; \
		fi; \
	done; \
	if [ $$failed -ne 0 ]; then \
		echo "Some CMocka tests failed!"; \
		exit 1; \
	fi

# Run all tests (legacy + CMocka)
test-all: test test-cmocka
	@echo "All tests completed."

distclean: clean
	rm -f Makefile

clean:
	rm -f core *.o *.log ${TESTPROGS} ${CMOCKA_TESTPROGS}

# DO NOT DELETE THIS LINE (or the blank line after it) -- make depend depends on them.

ircd_chattr_t.o: ircd_chattr_t.c ../../include/ircd_chattr.h
ircd_in_addr_t.o: ircd_in_addr_t.c ../../include/ircd_log.h \
  ../../include/ircd_string.h ../../include/ircd_chattr.h \
  ../../include/numnicks.h ../../include/client.h \
  ../../include/ircd_defs.h ../../include/dbuf.h ../../include/msgq.h \
  ../../include/ircd_events.h ../../config.h ../../include/ircd_handler.h \
  ../../include/res.h ../../include/capab.h ../../include/res.h
ircd_match_t.o: ircd_match_t.c ../../include/ircd_log.h \
  ../../include/match.h ../../include/res.h ../../config.h
ircd_string_t.o: ircd_string_t.c ../../include/ircd_string.h \
  ../../include/ircd_chattr.h
test_stub.o: test_stub.c ../../include/client.h ../../include/ircd_defs.h \
  ../../include/dbuf.h ../../include/msgq.h ../../include/ircd_events.h \
  ../../config.h ../../include/ircd_handler.h ../../include/res.h \
  ../../include/capab.h ../../include/ircd_log.h ../../include/s_debug.h
